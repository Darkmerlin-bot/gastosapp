<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>GastosApp</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body, #root { height: 100%; width: 100%; overflow-x: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; }
        input[type="date"], input[type="month"] { color-scheme: dark; }
        ::-webkit-scrollbar { width: 0; height: 0; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useRef, useEffect } = React;

const SUPABASE_URL = 'https://dyuwugtgcwaccvbhqvih.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5dXd1Z3RnY3dhY2N2YmhxdmloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5NDA0OTksImV4cCI6MjA4MjUxNjQ5OX0.RjdPmbJYMB6qRFFS1XsFlos-pRAULE4kV_Dr-VeRBbo';

const supabase = {
  from: (table) => ({
    select: async (columns = '*') => {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=${columns}&order=created_at.desc`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      });
      const data = await res.json();
      return { data, error: res.ok ? null : data };
    },
    insert: async (rows) => {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
        method: 'POST',
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
        body: JSON.stringify(rows)
      });
      const data = await res.json();
      return { data, error: res.ok ? null : data };
    },
    update: (data) => ({
      eq: async (column, value) => {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${column}=eq.${value}`, {
          method: 'PATCH',
          headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        return { data: result, error: res.ok ? null : result };
      }
    }),
    delete: () => ({
      eq: async (column, value) => {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${column}=eq.${value}`, {
          method: 'DELETE',
          headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
        });
        return { error: res.ok ? null : 'Error' };
      }
    })
  })
};

const categories = [
  { id: 'food', name: 'Comida', icon: 'üçî', color: '#FF6B6B' },
  { id: 'transport', name: 'Transporte', icon: 'üöó', color: '#4ECDC4' },
  { id: 'shopping', name: 'Compras', icon: 'üõçÔ∏è', color: '#FFE66D' },
  { id: 'entertainment', name: 'Ocio', icon: 'üé¨', color: '#A78BFA' },
  { id: 'health', name: 'Salud', icon: 'üíä', color: '#34D399' },
  { id: 'home', name: 'Hogar', icon: 'üè†', color: '#F472B6' },
  { id: 'services', name: 'Servicios', icon: 'üì±', color: '#60A5FA' },
  { id: 'other', name: 'Otros', icon: 'üì¶', color: '#9CA3AF' },
];

const incomeTypes = [
  { id: 'salary', name: 'Sueldo', icon: 'üíµ', color: '#10B981' },
  { id: 'bonus', name: 'Aguinaldo', icon: 'üéÅ', color: '#F59E0B' },
  { id: 'freelance', name: 'Extra', icon: 'üíª', color: '#8B5CF6' },
  { id: 'other', name: 'Otros', icon: 'üí∞', color: '#6B7280' },
];

const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

function SimpleChart({ data, maxValue }) {
  if (maxValue === 0) maxValue = 1;
  return (
    <div className="flex items-end justify-between gap-1 h-40">
      {data.map((item, i) => (
        <div key={i} className="flex-1 flex flex-col items-center gap-1">
          <div className="w-full flex gap-0.5 items-end h-32">
            <div className="flex-1 bg-emerald-500 rounded-t transition-all" style={{ height: `${(item.Ingresos / maxValue) * 100}%` }} title={`Ingresos: $${item.Ingresos}`} />
            <div className="flex-1 bg-red-500 rounded-t transition-all" style={{ height: `${(item.Gastos / maxValue) * 100}%` }} title={`Gastos: $${item.Gastos}`} />
          </div>
          <span className="text-xs text-slate-400">{item.name}</span>
        </div>
      ))}
    </div>
  );
}

function App() {
  const [users, setUsers] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [expenses, setExpenses] = useState([]);
  const [incomes, setIncomes] = useState([]);
  const [loading, setLoading] = useState(true);
  const [view, setView] = useState('home');
  const [modal, setModal] = useState(null);
  const [receiptImage, setReceiptImage] = useState(null);
  const [viewingReceipt, setViewingReceipt] = useState(null);
  const [newExpense, setNewExpense] = useState({ amount: '', description: '', category: 'food', date: new Date().toISOString().split('T')[0] });
  const [newIncome, setNewIncome] = useState({ amount: '', description: '', type: 'salary', date: new Date().toISOString().split('T')[0] });
  const [filterMonth, setFilterMonth] = useState(new Date().toISOString().slice(0, 7));
  const [filterYear, setFilterYear] = useState(new Date().getFullYear().toString());
  const [syncing, setSyncing] = useState(false);
  const [passwordInput, setPasswordInput] = useState('');
  const [passwordError, setPasswordError] = useState('');
  const [showSetPassword, setShowSetPassword] = useState(false);
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [selectedUserForLogin, setSelectedUserForLogin] = useState(null);
  const fileInputRef = useRef(null);

  useEffect(() => { loadData(); }, []);

  const loadData = async () => {
    setLoading(true);
    try {
      const [usersRes, expensesRes, incomesRes] = await Promise.all([
        supabase.from('users').select('*'),
        supabase.from('expenses').select('*'),
        supabase.from('incomes').select('*')
      ]);
      if (usersRes.data) setUsers(usersRes.data);
      if (expensesRes.data) setExpenses(expensesRes.data.map(e => ({
        ...e, userName: usersRes.data?.find(u => u.id === e.user_id)?.name || '',
        userAvatar: usersRes.data?.find(u => u.id === e.user_id)?.avatar || 'üë§',
        userId: e.user_id, createdAt: e.created_at, receipt: e.receipt_url
      })));
      if (incomesRes.data) setIncomes(incomesRes.data.map(i => ({
        ...i, userName: usersRes.data?.find(u => u.id === i.user_id)?.name || '',
        userAvatar: usersRes.data?.find(u => u.id === i.user_id)?.avatar || 'üë§',
        userId: i.user_id, createdAt: i.created_at
      })));
    } catch (err) { console.error('Error:', err); }
    setLoading(false);
  };

  const handleUserSelect = (user) => {
    if (user.password) {
      setSelectedUserForLogin(user);
      setPasswordInput('');
      setPasswordError('');
    } else {
      setSelectedUserForLogin(user);
      setShowSetPassword(true);
      setNewPassword('');
      setConfirmPassword('');
    }
  };

  const handleLogin = () => {
    if (passwordInput === selectedUserForLogin.password) {
      setCurrentUser(selectedUserForLogin);
      setSelectedUserForLogin(null);
      setPasswordInput('');
      setPasswordError('');
    } else {
      setPasswordError('Contrase√±a incorrecta');
    }
  };

  const handleSetPassword = async () => {
    if (newPassword.length < 4) {
      setPasswordError('M√≠nimo 4 caracteres');
      return;
    }
    if (newPassword !== confirmPassword) {
      setPasswordError('Las contrase√±as no coinciden');
      return;
    }
    setSyncing(true);
    const { error } = await supabase.from('users').update({ password: newPassword }).eq('id', selectedUserForLogin.id);
    if (!error) {
      const updatedUser = { ...selectedUserForLogin, password: newPassword };
      setUsers(users.map(u => u.id === updatedUser.id ? updatedUser : u));
      setCurrentUser(updatedUser);
      setShowSetPassword(false);
      setSelectedUserForLogin(null);
    }
    setSyncing(false);
  };

  const handleImageCapture = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setReceiptImage(reader.result);
      reader.readAsDataURL(file);
    }
  };

  const addExpense = async () => {
    if (!newExpense.amount || !currentUser) return;
    setSyncing(true);
    const { data, error } = await supabase.from('expenses').insert([{
      user_id: currentUser.id, amount: parseFloat(newExpense.amount), description: newExpense.description,
      category: newExpense.category, date: newExpense.date, receipt_url: receiptImage
    }]);
    if (!error && data) {
      setExpenses([{ ...data[0], userName: currentUser.name, userAvatar: currentUser.avatar, userId: currentUser.id, createdAt: data[0].created_at, receipt: data[0].receipt_url }, ...expenses]);
    }
    setNewExpense({ amount: '', description: '', category: 'food', date: new Date().toISOString().split('T')[0] });
    setReceiptImage(null); setModal(null); setSyncing(false);
  };

  const addIncome = async () => {
    if (!newIncome.amount || !currentUser) return;
    setSyncing(true);
    const { data, error } = await supabase.from('incomes').insert([{
      user_id: currentUser.id, amount: parseFloat(newIncome.amount), description: newIncome.description,
      type: newIncome.type, date: newIncome.date
    }]);
    if (!error && data) {
      setIncomes([{ ...data[0], userName: currentUser.name, userAvatar: currentUser.avatar, userId: currentUser.id, createdAt: data[0].created_at }, ...incomes]);
    }
    setNewIncome({ amount: '', description: '', type: 'salary', date: new Date().toISOString().split('T')[0] });
    setModal(null); setSyncing(false);
  };

  const deleteExpense = async (id) => { setSyncing(true); await supabase.from('expenses').delete().eq('id', id); setExpenses(expenses.filter(e => e.id !== id)); setSyncing(false); };
  const deleteIncome = async (id) => { setSyncing(true); await supabase.from('incomes').delete().eq('id', id); setIncomes(incomes.filter(i => i.id !== id)); setSyncing(false); };

  const filteredExpenses = expenses.filter(e => e.date?.startsWith(filterMonth));
  const filteredIncomes = incomes.filter(i => i.date?.startsWith(filterMonth));
  const totalExpensesMonth = filteredExpenses.reduce((s, e) => s + parseFloat(e.amount || 0), 0);
  const totalIncomesMonth = filteredIncomes.reduce((s, i) => s + parseFloat(i.amount || 0), 0);
  
  // Balance acumulativo hist√≥rico (todos los ingresos - todos los gastos)
  const totalExpensesAll = expenses.reduce((s, e) => s + parseFloat(e.amount || 0), 0);
  const totalIncomesAll = incomes.reduce((s, i) => s + parseFloat(i.amount || 0), 0);
  const balanceTotal = totalIncomesAll - totalExpensesAll;

  const getUserStats = (userId) => {
    // Stats del mes
    const uExpMonth = filteredExpenses.filter(e => e.userId === userId || e.user_id === userId).reduce((s, e) => s + parseFloat(e.amount || 0), 0);
    const uIncMonth = filteredIncomes.filter(i => i.userId === userId || i.user_id === userId).reduce((s, i) => s + parseFloat(i.amount || 0), 0);
    // Balance acumulativo hist√≥rico por usuario
    const uExpAll = expenses.filter(e => e.userId === userId || e.user_id === userId).reduce((s, e) => s + parseFloat(e.amount || 0), 0);
    const uIncAll = incomes.filter(i => i.userId === userId || i.user_id === userId).reduce((s, i) => s + parseFloat(i.amount || 0), 0);
    return { expenses: uExpMonth, incomes: uIncMonth, balanceMonth: uIncMonth - uExpMonth, balance: uIncAll - uExpAll };
  };

  const getChartData = () => months.map((month, i) => {
    const ms = `${filterYear}-${String(i + 1).padStart(2, '0')}`;
    return { name: month, Ingresos: incomes.filter(x => x.date?.startsWith(ms)).reduce((s, x) => s + parseFloat(x.amount || 0), 0), Gastos: expenses.filter(x => x.date?.startsWith(ms)).reduce((s, x) => s + parseFloat(x.amount || 0), 0) };
  });

  const chartData = getChartData();
  const maxChartValue = Math.max(...chartData.map(d => Math.max(d.Ingresos, d.Gastos)), 1);

  if (loading) return (<div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 text-white flex flex-col items-center justify-center"><div className="text-6xl mb-4 animate-bounce">üí∞</div><p className="text-slate-400">Cargando...</p></div>);

  if (selectedUserForLogin && !showSetPassword) return (
    <div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 text-white flex flex-col items-center justify-center p-6">
      <button onClick={() => setSelectedUserForLogin(null)} className="absolute top-4 left-4 text-slate-400 text-lg">‚Üê Volver</button>
      <div className="text-5xl mb-4">{selectedUserForLogin.avatar}</div>
      <h2 className="text-xl font-bold mb-6">{selectedUserForLogin.name}</h2>
      <div className="w-full max-w-xs space-y-4">
        <input type="password" placeholder="Ingres√° tu contrase√±a" value={passwordInput} onChange={e => { setPasswordInput(e.target.value); setPasswordError(''); }} className="w-full bg-slate-800 rounded-xl p-4 outline-none border border-slate-700 text-white text-center text-lg" autoFocus />
        {passwordError && <p className="text-red-400 text-sm text-center">{passwordError}</p>}
        <button onClick={handleLogin} className="w-full py-4 rounded-xl font-semibold text-white bg-gradient-to-r from-blue-500 to-blue-600 active:scale-95">Entrar</button>
      </div>
    </div>
  );

  if (showSetPassword) return (
    <div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 text-white flex flex-col items-center justify-center p-6">
      <button onClick={() => { setShowSetPassword(false); setSelectedUserForLogin(null); }} className="absolute top-4 left-4 text-slate-400 text-lg">‚Üê Volver</button>
      <div className="text-5xl mb-4">{selectedUserForLogin.avatar}</div>
      <h2 className="text-xl font-bold mb-2">{selectedUserForLogin.name}</h2>
      <p className="text-slate-400 text-sm mb-6 text-center">Cre√° una contrase√±a para proteger tu cuenta</p>
      <div className="w-full max-w-xs space-y-4">
        <input type="password" placeholder="Nueva contrase√±a" value={newPassword} onChange={e => { setNewPassword(e.target.value); setPasswordError(''); }} className="w-full bg-slate-800 rounded-xl p-4 outline-none border border-slate-700 text-white" autoFocus />
        <input type="password" placeholder="Confirmar contrase√±a" value={confirmPassword} onChange={e => { setConfirmPassword(e.target.value); setPasswordError(''); }} className="w-full bg-slate-800 rounded-xl p-4 outline-none border border-slate-700 text-white" />
        {passwordError && <p className="text-red-400 text-sm text-center">{passwordError}</p>}
        <button onClick={handleSetPassword} disabled={syncing} className="w-full py-4 rounded-xl font-semibold text-white bg-gradient-to-r from-emerald-500 to-emerald-600 active:scale-95 disabled:opacity-50">{syncing ? 'Guardando...' : 'Crear contrase√±a'}</button>
      </div>
    </div>
  );

  if (!currentUser) return (
    <div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 text-white flex flex-col items-center justify-center p-6">
      <div className="text-6xl mb-4">üí∞</div>
      <h1 className="text-3xl font-bold bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent mb-2">GastosApp</h1>
      <p className="text-slate-400 mb-8">Finanzas en pareja</p>
      <div className="grid grid-cols-2 gap-4 w-full max-w-xs">
        {users.map(u => (
          <button key={u.id} onClick={() => handleUserSelect(u)} className="flex flex-col items-center gap-3 p-6 rounded-2xl border-2 active:scale-95 transition-transform" style={{ borderColor: u.color, background: `linear-gradient(135deg, ${u.color}20, transparent)` }}>
            <span className="text-5xl">{u.avatar}</span>
            <span className="font-semibold">{u.name}</span>
            {u.password && <span className="text-xs text-slate-400">üîí</span>}
          </button>
        ))}
      </div>
      <p className="text-xs text-emerald-500 mt-8">‚úì Conectado</p>
    </div>
  );

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 text-white pb-28">
      {syncing && <div className="fixed top-0 left-0 right-0 bg-blue-500 text-center py-1 text-xs z-50">Sincronizando...</div>}
      <header className="p-5 flex items-center gap-3">
        <button onClick={() => setCurrentUser(null)} className="w-11 h-11 rounded-xl flex items-center justify-center text-2xl active:scale-95" style={{ background: currentUser.color }}>{currentUser.avatar}</button>
        <div className="flex-1"><p className="font-semibold">Hola, {currentUser.name}</p><p className="text-xs text-slate-400">{new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}</p></div>
        <button onClick={loadData} className="w-10 h-10 rounded-xl bg-slate-700 flex items-center justify-center text-lg active:scale-95">üîÑ</button>
      </header>
      <main className="px-5">
        <input type="month" value={filterMonth} onChange={e => { setFilterMonth(e.target.value); setFilterYear(e.target.value.split('-')[0]); }} className="mb-4 bg-slate-700/50 border-0 rounded-lg px-3 py-2 text-sm text-white" />
        <div className="bg-gradient-to-br from-slate-700/50 to-slate-800/50 rounded-3xl p-5 mb-4 border border-slate-600/30">
          <p className="text-sm text-slate-400">Balance total acumulado</p>
          <p className={`text-3xl font-bold ${balanceTotal >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>${balanceTotal.toLocaleString('es-ES')}</p>
          <p className="text-xs text-slate-500 mt-1">Dinero disponible en cuenta</p>
          <div className="flex gap-3 mt-4">
            <div className="flex-1 bg-emerald-500/20 rounded-xl p-3"><p className="text-xs text-emerald-400">üíµ Ingresos mes</p><p className="text-lg font-bold text-emerald-400">+${totalIncomesMonth.toLocaleString('es-ES')}</p></div>
            <div className="flex-1 bg-red-500/20 rounded-xl p-3"><p className="text-xs text-red-400">üí∏ Gastos mes</p><p className="text-lg font-bold text-red-400">-${totalExpensesMonth.toLocaleString('es-ES')}</p></div>
          </div>
        </div>
        <div className="flex gap-3 mb-6">
          {users.map(u => { const s = getUserStats(u.id); return (
            <div key={u.id} className="flex-1 rounded-2xl p-4 border" style={{ background: `linear-gradient(135deg, ${u.color}20, transparent)`, borderColor: `${u.color}40` }}>
              <div className="flex items-center gap-2 mb-2"><span className="text-2xl">{u.avatar}</span><span className="font-medium text-sm">{u.name}</span></div>
              <p className={`text-xl font-bold ${s.balance >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>${s.balance.toLocaleString('es-ES')}</p>
              <p className="text-xs text-slate-500">Total acumulado</p>
              <div className="mt-2 pt-2 border-t border-slate-700">
                <p className="text-xs text-slate-400">Este mes:</p>
                <p className="text-xs text-emerald-400">+${s.incomes.toLocaleString('es-ES')}</p>
                <p className="text-xs text-red-400">-${s.expenses.toLocaleString('es-ES')}</p>
              </div>
            </div>
          ); })}
        </div>
        <div className="flex gap-2 bg-slate-800/50 p-1.5 rounded-2xl mb-6">
          {[{ id: 'home', icon: 'üè†' }, { id: 'chart', icon: 'üìä' }, { id: 'incomes', icon: 'üíµ' }, { id: 'expenses', icon: 'üí∏' }].map(t => (
            <button key={t.id} onClick={() => setView(t.id)} className={`flex-1 py-2.5 rounded-xl text-lg ${view === t.id ? 'bg-slate-700' : ''}`}>{t.icon}</button>
          ))}
        </div>
        {view === 'home' && (
          <div className="space-y-3">
            <h3 className="font-semibold">√öltimos movimientos</h3>
            {filteredExpenses.length === 0 && filteredIncomes.length === 0 ? <p className="text-center text-slate-400 py-8">No hay movimientos</p> :
              [...filteredIncomes.map(i => ({ ...i, isIncome: true })), ...filteredExpenses.map(e => ({ ...e, isIncome: false }))].sort((a, b) => new Date(b.createdAt || b.created_at) - new Date(a.createdAt || a.created_at)).slice(0, 10).map(item => {
                const cat = item.isIncome ? incomeTypes.find(t => t.id === item.type) : categories.find(c => c.id === item.category);
                return (<div key={item.id} className="flex items-center gap-3 bg-slate-800/40 rounded-xl p-4 border border-slate-700/50">
                  <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ background: `${cat?.color}30` }}>{cat?.icon}</div>
                  <div className="flex-1 min-w-0"><p className="font-medium truncate">{item.description || cat?.name}</p><p className="text-xs text-slate-400">{item.userAvatar} {item.userName} ‚Ä¢ {item.date}</p></div>
                  {!item.isIncome && item.receipt && <button onClick={() => setViewingReceipt(item.receipt)} className="text-lg">üßæ</button>}
                  <p className={`font-semibold ${item.isIncome ? 'text-emerald-400' : 'text-red-400'}`}>{item.isIncome ? '+' : '-'}${parseFloat(item.amount).toLocaleString('es-ES')}</p>
                </div>);
              })}
          </div>
        )}
        {view === 'chart' && (
          <div className="space-y-4">
            <h3 className="font-semibold">Resumen {filterYear}</h3>
            <div className="bg-slate-800/40 rounded-2xl p-4 border border-slate-700/50">
              <div className="flex gap-4 mb-3 justify-center"><div className="flex items-center gap-2"><div className="w-3 h-3 bg-emerald-500 rounded"/><span className="text-xs text-slate-400">Ingresos</span></div><div className="flex items-center gap-2"><div className="w-3 h-3 bg-red-500 rounded"/><span className="text-xs text-slate-400">Gastos</span></div></div>
              <SimpleChart data={chartData} maxValue={maxChartValue} />
            </div>
            <div className="grid grid-cols-3 gap-2">
              <div className="bg-emerald-500/20 rounded-xl p-3 text-center"><p className="text-xs text-emerald-400">Ingresos</p><p className="text-base font-bold text-emerald-400">${incomes.filter(i => i.date?.startsWith(filterYear)).reduce((s, i) => s + parseFloat(i.amount || 0), 0).toLocaleString('es-ES')}</p></div>
              <div className="bg-red-500/20 rounded-xl p-3 text-center"><p className="text-xs text-red-400">Gastos</p><p className="text-base font-bold text-red-400">${expenses.filter(e => e.date?.startsWith(filterYear)).reduce((s, e) => s + parseFloat(e.amount || 0), 0).toLocaleString('es-ES')}</p></div>
              <div className="bg-purple-500/20 rounded-xl p-3 text-center"><p className="text-xs text-purple-400">Balance</p><p className="text-base font-bold text-purple-400">${(incomes.filter(i => i.date?.startsWith(filterYear)).reduce((s, i) => s + parseFloat(i.amount || 0), 0) - expenses.filter(e => e.date?.startsWith(filterYear)).reduce((s, e) => s + parseFloat(e.amount || 0), 0)).toLocaleString('es-ES')}</p></div>
            </div>
          </div>
        )}
        {view === 'incomes' && (
          <div className="space-y-3">
            <h3 className="font-semibold">Ingresos del mes</h3>
            {filteredIncomes.length === 0 ? <p className="text-center text-slate-400 py-8">No hay ingresos</p> : filteredIncomes.map(i => {
              const t = incomeTypes.find(x => x.id === i.type);
              return (<div key={i.id} className="flex items-center gap-3 bg-slate-800/40 rounded-xl p-4 border border-slate-700/50">
                <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ background: `${t?.color}30` }}>{t?.icon}</div>
                <div className="flex-1"><p className="font-medium">{i.description || t?.name}</p><p className="text-xs text-slate-400">{i.userAvatar} {i.userName} ‚Ä¢ {i.date}</p></div>
                <p className="font-semibold text-emerald-400">+${parseFloat(i.amount).toLocaleString('es-ES')}</p>
                <button onClick={() => deleteIncome(i.id)} className="text-red-400/60 active:scale-90">üóëÔ∏è</button>
              </div>);
            })}
          </div>
        )}
        {view === 'expenses' && (
          <div className="space-y-3">
            <h3 className="font-semibold">Gastos del mes</h3>
            {filteredExpenses.length === 0 ? <p className="text-center text-slate-400 py-8">No hay gastos</p> : filteredExpenses.map(e => {
              const c = categories.find(x => x.id === e.category);
              return (<div key={e.id} className="flex items-center gap-3 bg-slate-800/40 rounded-xl p-4 border border-slate-700/50">
                <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ background: `${c?.color}30` }}>{c?.icon}</div>
                <div className="flex-1"><p className="font-medium">{e.description || c?.name}</p><p className="text-xs text-slate-400">{e.userAvatar} {e.userName} ‚Ä¢ {e.date}</p></div>
                {e.receipt && <button onClick={() => setViewingReceipt(e.receipt)} className="text-lg">üßæ</button>}
                <p className="font-semibold text-red-400">-${parseFloat(e.amount).toLocaleString('es-ES')}</p>
                <button onClick={() => deleteExpense(e.id)} className="text-red-400/60 active:scale-90">üóëÔ∏è</button>
              </div>);
            })}
          </div>
        )}
      </main>
      <div className="fixed bottom-6 right-6 flex flex-col gap-3 z-40">
        <button onClick={() => setModal('income')} className="w-14 h-14 rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 text-2xl shadow-lg shadow-emerald-500/30 active:scale-90">üíµ</button>
        <button onClick={() => setModal('expense')} className="w-14 h-14 rounded-2xl bg-gradient-to-br from-red-500 to-red-600 text-2xl shadow-lg shadow-red-500/30 active:scale-90">‚àí</button>
      </div>
      {modal && (
        <div className="fixed inset-0 bg-black/80 flex items-end justify-center z-50" onClick={() => { setModal(null); setReceiptImage(null); }}>
          <div className="bg-slate-900 rounded-t-3xl w-full max-h-[90vh] overflow-auto p-6" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-5">
              <h2 className={`text-xl font-bold ${modal === 'income' ? 'text-emerald-400' : 'text-red-400'}`}>{modal === 'income' ? 'üíµ Nuevo ingreso' : 'üí∏ Nuevo gasto'}</h2>
              <button onClick={() => { setModal(null); setReceiptImage(null); }} className="w-9 h-9 rounded-full bg-slate-700 flex items-center justify-center">‚úï</button>
            </div>
            <div className="space-y-4">
              <div><label className="text-sm text-slate-400 block mb-1">Monto</label>
                <div className={`flex items-center gap-2 rounded-xl p-4 border ${modal === 'income' ? 'bg-emerald-500/10 border-emerald-500/30' : 'bg-red-500/10 border-red-500/30'}`}>
                  <span className={`text-2xl font-bold ${modal === 'income' ? 'text-emerald-400' : 'text-red-400'}`}>$</span>
                  <input type="number" inputMode="decimal" placeholder="0" value={modal === 'income' ? newIncome.amount : newExpense.amount} onChange={e => modal === 'income' ? setNewIncome({ ...newIncome, amount: e.target.value }) : setNewExpense({ ...newExpense, amount: e.target.value })} className="flex-1 bg-transparent text-2xl font-bold outline-none text-white" />
                </div>
              </div>
              <div><label className="text-sm text-slate-400 block mb-1">Descripci√≥n</label><input type="text" placeholder={modal === 'income' ? 'Ej: Sueldo' : 'Ej: Supermercado'} value={modal === 'income' ? newIncome.description : newExpense.description} onChange={e => modal === 'income' ? setNewIncome({ ...newIncome, description: e.target.value }) : setNewExpense({ ...newExpense, description: e.target.value })} className="w-full bg-slate-800 rounded-xl p-4 outline-none border border-slate-700 text-white" /></div>
              <div><label className="text-sm text-slate-400 block mb-1">Fecha</label><input type="date" value={modal === 'income' ? newIncome.date : newExpense.date} onChange={e => modal === 'income' ? setNewIncome({ ...newIncome, date: e.target.value }) : setNewExpense({ ...newExpense, date: e.target.value })} className="w-full bg-slate-800 rounded-xl p-4 outline-none border border-slate-700 text-white" /></div>
              {modal === 'expense' && (<div><label className="text-sm text-slate-400 block mb-2">üì∑ Foto del recibo</label><input ref={fileInputRef} type="file" accept="image/*" capture="environment" onChange={handleImageCapture} className="hidden" />
                {receiptImage ? (<div className="relative"><img src={receiptImage} alt="Recibo" className="w-full h-40 object-cover rounded-xl" /><button onClick={() => setReceiptImage(null)} className="absolute top-2 right-2 w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white">‚úï</button></div>
                ) : (<button onClick={() => fileInputRef.current?.click()} className="w-full border-2 border-dashed border-slate-600 rounded-xl p-6 flex flex-col items-center gap-2 active:border-slate-500"><span className="text-4xl">üì∏</span><span className="text-slate-400 text-sm">Toca para sacar foto</span></button>)}
              </div>)}
              <div><label className="text-sm text-slate-400 block mb-2">{modal === 'income' ? 'Tipo' : 'Categor√≠a'}</label>
                <div className="grid grid-cols-4 gap-2">
                  {(modal === 'income' ? incomeTypes : categories).map(item => {
                    const selected = modal === 'income' ? newIncome.type === item.id : newExpense.category === item.id;
                    return (<button key={item.id} onClick={() => modal === 'income' ? setNewIncome({ ...newIncome, type: item.id }) : setNewExpense({ ...newExpense, category: item.id })} className={`flex flex-col items-center gap-1 p-3 rounded-xl border-2 active:scale-95 ${selected ? '' : 'border-slate-700 bg-slate-800/50'}`} style={selected ? { borderColor: item.color, background: `${item.color}30` } : {}}><span className="text-xl">{item.icon}</span><span className="text-xs">{item.name}</span></button>);
                  })}
                </div>
              </div>
              <button onClick={modal === 'income' ? addIncome : addExpense} disabled={(modal === 'income' ? !newIncome.amount : !newExpense.amount) || syncing} className={`w-full py-4 rounded-xl font-semibold text-white active:scale-98 ${modal === 'income' ? 'bg-gradient-to-r from-emerald-500 to-emerald-600' : 'bg-gradient-to-r from-red-500 to-red-600'} disabled:opacity-50`}>{syncing ? 'Guardando...' : `Guardar ${modal === 'income' ? 'ingreso' : 'gasto'}`}</button>
            </div>
          </div>
        </div>
      )}
      {viewingReceipt && (<div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onClick={() => setViewingReceipt(null)}><div className="relative max-w-full max-h-full"><img src={viewingReceipt} alt="Recibo" className="max-w-full max-h-[80vh] rounded-xl object-contain" /><button onClick={() => setViewingReceipt(null)} className="absolute top-2 right-2 w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center text-white text-xl">‚úï</button></div></div>)}
    </div>
  );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
